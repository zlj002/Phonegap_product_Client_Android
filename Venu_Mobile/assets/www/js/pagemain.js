var installListMain=[];var pmain={initialize:function(){$.ui.ready(function(){var e=localMobelAuthentication.verify();if(e){pmain.installAppList();pmain.getMainDisplayNews()}})},getSchoolInfo:function(){var e=localMobelInfo.getSchoolServerHost();return MY_JSON.parse(e)},getFacultyInfo:function(){var e=localMobelInfo.getFacultyInfo();return MY_JSON.parse(e)},getUserInfo:function(){var e=localMobelInfo.getUserInfo();console.log(e);return MY_JSON.parse(e)},initEvents:function(){$.each($(".tswipe-wrap .col3"),function(e,i){var t=$(i).find("a").attr("topanelid");var a=$(i).find("a").attr("thirdpartyurl");var n=encodeURIComponent($(i).find("[class=featureFont]").html());$(i).unbind().on("click",function(){pmain.deleteBadgeByUserIDAndFeatureID(t.replace("#",""));if(a==null||typeof a=="undefined"||a=="null"||a==""){$.ui.loadContent(t,false,false,"left")}else{if(a.indexOf("?")>-1){a=a+"&vUserNO="+localMobelInfo.getUserName()+"&vSchoolID"+pmain.getSchoolInfo().ID+"&vUserType="+localMobelInfo.getUserType()+"&vSchoolID="+pmain.getSchoolInfo().ID+"&vTitle="+n}else{a=a+"?vUserNO="+localMobelInfo.getUserName()+"&vSchoolID"+pmain.getSchoolInfo().ID+"&vUserType="+localMobelInfo.getUserType()+"&vSchoolID="+pmain.getSchoolInfo().ID+"&vTitle="+n}var e=window.open(a,"_blank","clearcache=yes")}})})},getMainDisplayNews:function(){if(serverHost!=""){$("#swipeTops .tswipe-wrap,#positionTop").html("");$.ui.showMask("正在加载……");var e={schoolID:pmain.getSchoolInfo().ID};var i=serverHost+"/MobileService/NewsService/NewsWebService.asmx/GetMainDisplayListBySchoolID";$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:i,data:MY_JSON.stringify(e),dataType:"json",success:function(e){var i=MY_JSON.parse(e.d);if(i.ReturnFlag==1){if(i.List.length==0){$("#swipeTops").hide()}else{$.each(i.List,function(e,i){var t=$('<div><div class="grid"><div class="col1"> <img src="'+i.CoverImage+'" style="width:100%;height:180px;" /> <div class="swipeTitle"></div><div class="swipeTitleFont">'+i.Digest+"</div></div></div></div>");t.unbind().on("tap",function(){var e=encodeURIComponent(i.Digest.length>4?i.Digest.substr(0,4)+"...":i.Digest);var t=window.open(serverHost+"/publicModule/News/Detail.aspx?id="+i.ID+"&vTitle="+e,"_blank","clearcache=yes")});$("#swipeTops .tswipe-wrap").append(t);var a=$("<em >&bull;</em>");$("#positionTop").append(a)});pmain.initNewsLeftRightTab()}}$.ui.hideMask()},error:function(e){$.ui.hideMask();$.ui.popup({title:"提示",message:"获取新闻失败",cancelText:"确定",cancelCallback:function(){},cancelOnly:true})}})}},installAppList:function(){if(serverHost!=""){$.ui.showMask("正在加载……");var e={schoolID:pmain.getSchoolInfo().ID,userID:localMobelInfo.getUserName()};var i=serverHost+"/MobileService/UserService/UserService.asmx/GetSys_FeatureByCurrentUser";$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:i,data:MY_JSON.stringify(e),dataType:"json",success:function(e){var i=MY_JSON.parse(e.d);installListMain=i.List;pmain.initApps();$.ui.hideMask()},error:function(e){$.ui.hideMask();$.ui.popup({title:"提示",message:"加载应用失败",cancelText:"确定",cancelCallback:function(){},cancelOnly:true})}})}else{pmain.initApps()}},initApps:function(){$("#tSwipe .tswipe-wrap").html("");$("#position").html("");var e="redBadge46";$.each(installListMain,function(i,t){if($("#tSwipe .tswipe-wrap .col3").length%9==0){var a=$('<div><div class="grid"></div></div>');$("#tSwipe .tswipe-wrap").append(a);var n=$("<em >&bull;</em>");$("#position").append(n)}var s=$('<div class="col3"><a thirdpartyurl="'+t.FeatureUrl+'" topanelid="#'+t.FeatureID+'"><img src="'+t.FeatureIcon+'" width="64" height="64" /><br /><font class="featureFont">'+t.FeatureName+'</font></a><div id="badge'+t.FeatureID+'"  class="'+e+'">1</div></div>');$("#tSwipe .tswipe-wrap .grid:last").append(s)});$("#position em:first").addClass("on");pmain.initLeftRightTab();pmain.initEvents();pmain.showNewMessageRedPonit()},initNewsLeftRightTab:function(){var e=document.getElementById("swipeTops");window.st=new Swipe(e,{startSlide:0,speed:400,continuous:false,disableScroll:false,stopPropagation:false,callback:function(e,i){$.each($("#positionTop em"),function(i,t){if(e==i){$(t).addClass("on")}else{$(t).removeClass("on")}})},transitionEnd:function(e,i){}})},initLeftRightTab:function(){var e=document.getElementById("tSwipe");window.ts=new Swipe(e,{startSlide:0,speed:400,continuous:false,disableScroll:false,stopPropagation:false,callback:function(e,i){$.each($("#position em"),function(i,t){if(e==i){$(t).addClass("on")}else{$(t).removeClass("on")}})},transitionEnd:function(e,i){}})},showNewMessageRedPonit:function(){var e={userID:localMobelInfo.getUserName()};var i=serverHost+"/MobileService/PushService/PushWebService.asmx/GetBadgeCountByUserID";$.ajax({type:"post",contentType:"application/json; charset=utf-8",url:i,data:MY_JSON.stringify(e),dataType:"json",success:function(e){$(".redBadge46").css("visibility","hidden");$(".redBadgeBottom").css("visibility","hidden");var i=MY_JSON.parse(e.d);$.each(i.List,function(e,i){$("#badge"+i.FeatureID).css("visibility","visible").html(i.BadgeCount);if($("#badge"+i.FeatureID).length>0){$("#bottomRedPageMain").css("visibility","visible")}else{$("#bottomRed"+i.FeatureID).css("visibility","visible")}})},error:function(e){}})},deleteBadgeByUserIDAndFeatureID:function(e){var i={userID:localMobelInfo.getUserName(),featureID:e};var t=serverHost+"/MobileService/PushService/PushWebService.asmx/DeleteBadgeByUserIDAndFeatureID";$.ajax({type:"post",contentType:"application/json; charset=utf-8",url:t,data:MY_JSON.stringify(i),dataType:"json",success:function(e){pmain.showNewMessageRedPonit()},error:function(e){}})}};