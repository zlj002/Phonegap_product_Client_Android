var chat={};var chatStatus="";var isForceQuitAlert=false;var localMobelNotice={initialize:function(){try{var e=localMobelInfo.getUserName();if(chatStatus!="connected"&&e!=null&&e!=""){this.bindEvents()}}catch(a){}},bindEvents:function(){this.start()},start:function(){$.connection.hub.url=serverHost+"/signalr";chat=$.connection.chatHub;chat.client.receiveNotice=function(e,a,t){try{var n=["新消息",t];window.plugins.notify.send(n,function(){navigator.notification.beep(1)},function(e){})}catch(o){}};chat.client.forceQuit=function(e){var a=MY_JSON.parse(e);var t="您的帐号在其他设备登录，您被迫下线";if(a.Platform!=null&&a.DeviceName!=null){t="您的帐号在其他设备["+a.Platform+","+a.DeviceName+"]登录，您被迫下线"}if(!isForceQuitAlert){isForceQuitAlert=true;$.ui.popup({title:"提示",message:"您的帐号在其他设备登录，您被迫下线",cancelText:"确定",cancelCallback:function(){isForceQuitAlert=false},cancelOnly:true})}localMobelAuthentication.logout()};chat.client.receiveMessageFromSomeOne=function(e,a,t,n,o){var i=localMobelInfo.getReceiveMessage(a);if(i!=a){localMobelInfo.updateReceiveMessage(a);var s=localMobelInfo.getUserName();if(n=="ADDFRIEND"){if(t!=s){localMobelInfo.updateNotice(n);try{var c=["新消息","好友申请"];window.plugins.notify.send(c,function(){navigator.notification.beep(1)},function(e){})}catch(l){}localMobelInfo.updateNewMessage(t);pmain.showNewMessageRedPonit()}}else if(n=="REJECTFRIEND"){if(t!=s){localMobelInfo.updateNotice(n);try{var c=["新消息","好友申请被拒绝"];window.plugins.notify.send(c,function(){navigator.notification.beep(1)},function(e){})}catch(l){}localMobelInfo.updateNewMessage(t);pmain.showNewMessageRedPonit()}}else{var r=$.ui.activeDiv.id;if(r=="chatDetail"){if(pPhatDetail.conversationID==""||typeof pPhatDetail.conversationID=="undefined"){pPhatDetail.conversationID=e}if($($('tr[messageid="'+a+'"]'),$("#tableMessages")).length==0){if(s==t){var p="img/defaultheader.png";var d=serverHost+"/MobileService/UserInfoService/UserInfoService.asmx/GetHeaderImageByUserNO";var f={userNO:s};$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:d,async:false,data:MY_JSON.stringify(f),dataType:"json",success:function(e){var a=MY_JSON.parse(e.d);if(a.ReturnFlag=="1"){p=serverHost+a.HeaderImage}},error:function(e){}});var v=localMobelInfo.getName();var g=$('<tr messageid="'+a+'"><td class="messageTd"><div class="headImgRight" style="width:48px; height:88px;"><img src="'+p+'" class="headImgRight" width="48px" height="48px" /><div>'+v+'</div></div><div class="popover left messageLeft"><div class="arrow"></div><div class="popover-content"><p>'+app.replace_em(n)+"</p></div></div></td></tr>");g.unbind().bind("longTap",function(e){e.stopPropagation();console.log("长按");$.ui.popup({title:"提示",message:"要删除此聊天记录?",cancelText:"取消",cancelCallback:function(){},doneText:"确定",doneCallback:function(){console.log("Done for!");pPhatDetail.deleteMessageDetail(a)},cancelOnly:false});return false});$("#tableMessages").append(g)}var u=$("#chatDetail").attr("detailID");if(u==t){var h="img/defaultheader.png";var d=serverHost+"/MobileService/UserInfoService/UserInfoService.asmx/GetHeaderImageByUserNO";var f={userNO:u};$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:d,async:false,data:MY_JSON.stringify(f),dataType:"json",success:function(e){var a=MY_JSON.parse(e.d);if(a.ReturnFlag=="1"){h=serverHost+a.HeaderImage}},error:function(e){}});var m=$("#chatTitle").html();var g=$('<tr  messageid="'+a+'"><td class="messageTd" ><div class="headImgLeft" style="width:48px; height:88px;"><img src="'+h+'" class="headImgLeft"  width="48px" height="48px"  /><div>'+m+'</div></div><div class="popover right messageRight" ><div class="arrow"></div><div class="popover-content"><p>'+app.replace_em(n)+"</p></div></div></td></tr>");g.unbind().bind("longTap",function(e){e.stopPropagation();console.log("长按");$.ui.popup({title:"提示",message:"要删除此聊天记录?",cancelText:"取消",cancelCallback:function(){},doneText:"确定",doneCallback:function(){console.log("Done for!");pPhatDetail.deleteMessageDetail(a)},cancelOnly:false});return false});$("#tableMessages").append(g)}else if(s!=t&&u!=t){localMobelInfo.updateNewMessage(t);pmain.showNewMessageRedPonit()}}$.ui.scrollToBottom(r)}else{if(t!=s){localMobelInfo.updateNewMessage(t);pmain.showNewMessageRedPonit();localMobelInfo.updateNotice(n);try{var c=["新消息",n];window.plugins.notify.send(c,function(){navigator.notification.beep(1)},function(e){})}catch(l){}}}}}};chat.client.receiveMessageFromGroup=function(e,a,t,n,o,i){var s=localMobelInfo.getReceiveMessage(a);if(s!=a){localMobelInfo.updateReceiveMessage(a);var c=localMobelInfo.getUserName();if(o=="ADDFRIEND"){}else if(o=="REJECTFRIEND"){}else{var l=$.ui.activeDiv.id;if(l=="chatDetail"){if(pPhatDetail.conversationID==""||typeof pPhatDetail.conversationID=="undefined"){pPhatDetail.conversationID=e}if($($('tr[messageid="'+a+'"]'),$("#tableMessages")).length==0){if(c.toUpperCase()==t.toUpperCase()){var r="img/defaultheader.png";var p=serverHost+"/MobileService/UserInfoService/UserInfoService.asmx/GetHeaderImageByUserNO";var d={userNO:c};$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:p,async:false,data:MY_JSON.stringify(d),dataType:"json",success:function(e){var a=MY_JSON.parse(e.d);if(a.ReturnFlag=="1"){r=serverHost+a.HeaderImage}},error:function(e){}});var f=localMobelInfo.getName();var v=$('<tr messageid="'+a+'"><td class="messageTd"><div class="headImgRight" style="width:48px; height:88px;"><img src="'+r+'" class="headImgRight" width="48px" height="48px" /><div>'+f+'</div></div><div class="popover left messageLeft"><div class="arrow"></div><div class="popover-content"><p>'+app.replace_em(o)+"</p></div></div></td></tr>");v.unbind().bind("longTap",function(e){e.stopPropagation();console.log("长按");$.ui.popup({title:"提示",message:"要删除此聊天记录?",cancelText:"取消",cancelCallback:function(){},doneText:"确定",doneCallback:function(){console.log("Done for!");pPhatDetail.deleteMessageDetail(a)},cancelOnly:false});return false});$("#tableMessages").append(v)}var g=$("#chatDetail").attr("detailID");if(g.toUpperCase()==n.toUpperCase()&&t.toUpperCase()!=c.toUpperCase()){var u="img/defaultheader.png";var p=serverHost+"/MobileService/UserInfoService/UserInfoService.asmx/GetHeaderImageByUserNO";var d={userNO:t};$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:p,async:false,data:MY_JSON.stringify(d),dataType:"json",success:function(e){var a=MY_JSON.parse(e.d);if(a.ReturnFlag=="1"){u=serverHost+a.HeaderImage}},error:function(e){}});var h=$("#chatTitle").html();var p=serverHost+"/MobileService/UserInfoService/UserInfoService.asmx/GetUserInfoByUserNo";var m={userNO:t};$.ajax({type:"Post",contentType:"application/json; charset=utf-8",url:p,data:MY_JSON.stringify(m),dataType:"json",async:false,success:function(e){var a=MY_JSON.parse(e.d);h=a.UserInfo.XM},error:function(e){$.ui.hideMask();$.ui.popup({title:"提示",message:"服务器地址"+serverHost+"异常，请检查配置",cancelText:"确定",cancelCallback:function(){},cancelOnly:true})}});var v=$('<tr  messageid="'+a+'"><td class="messageTd" ><div class="headImgLeft" style="width:48px; height:88px;"><img src="'+u+'" class="headImgLeft"  width="48px" height="48px"  /><div>'+h+'</div></div><div class="popover right messageRight" ><div class="arrow"></div><div class="popover-content"><p>'+app.replace_em(o)+"</p></div></div></td></tr>");v.unbind().bind("longTap",function(e){e.stopPropagation();console.log("长按");$.ui.popup({title:"提示",message:"要删除此聊天记录?",cancelText:"取消",cancelCallback:function(){},doneText:"确定",doneCallback:function(){console.log("Done for!");pPhatDetail.deleteMessageDetail(a)},cancelOnly:false});return false});$("#tableMessages").append(v)}else{localMobelInfo.updateNewMessage(n);pmain.showNewMessageRedPonit()}}$.ui.scrollToBottom(l)}else{if(t.toUpperCase()!=c.toUpperCase()){localMobelInfo.updateNewMessage(n);pmain.showNewMessageRedPonit();localMobelInfo.updateNotice(o);try{var M=["新消息",o];window.plugins.notify.send(M,function(){navigator.notification.beep(1)},function(e){})}catch(b){}}}}}};$.connection.hub.start().done(function(){try{var e=localMobelInfo.getUserName();var a=1;var t=device.platform;var n=device.model;var o=device.uuid;var i=device.version;chat.server.registClientID(e,a,t,n,o,i)}catch(s){}}).fail(function(e){alert("即时通讯服务连接失败，您将无法及时收到通知,服务地址："+serverHost)});$.connection.hub.stateChanged(function(e){if(e.newState===$.signalR.connectionState.reconnecting){chatStatus="reconnecting"}else if(e.newState===$.signalR.connectionState.connected){chatStatus="connected"}else if(e.newState===$.signalR.connectionState.disconnected){chatStatus="disconnected"}else{chatStatus=""}})},stop:function(){try{chat.connection.stop(true,true)}catch(e){}}};